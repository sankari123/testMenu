<!DOCTYPE html>
<html>
  <head>
    <title>MeMO</title>
	
    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    <script type="text/javascript" charset="utf-8"></script>
   <script src="Base64ToPNG.js" type="text/javascript"></script>
   <script>
        var imgDataUrl;
	      var start = function() {
       screen.orientation.lock('portrait');
        }
    var canvas,ctx;
    var mouseX,mouseY,mouseDown=0;
    var touchX,touchY;
    var lastX,lastY=-1;
	  var tmp;
    var pictureSource;   // picture source
    var destinationType; // sets the format of returned value
   var img, rotating = false; 
    document.addEventListener("deviceready",onDeviceReady,false);

    
    function onDeviceReady() {
        pictureSource=navigator.camera.PictureSourceType;
        destinationType=navigator.camera.DestinationType;
	
    }

    function capturePhoto() {
    navigator.camera.getPicture(onPhotoDataSuccess, onFail, { quality: 50, destinationType: destinationType.DATA_URL });
    }
    function onPhotoDataSuccess(imageData) {
   var c = document.getElementById("can_model");
   var ctx = c.getContext("2d");
   var img = new Image();
   img.onload= = function () {
                // reset the canvas with new dimensions
                rotating=true;
                var cw = c.width;
    		var ch = c.height;
                c.width = ch;
                c.height = cw;
                cw = c.width;
                ch = c.height;

                ctx.save();
                // translate and rotate
                ctx.translate(cw, ch / cw);
                ctx.rotate(Math.PI / 2);
                // draw the previows image, now rotated
                ctx.drawImage(img, 0, 0);               
                ctx.restore();
   }img.src = "data:image/jpeg;base64," + imageData;
                // clear the temporary image
             //   img = null;
               
                rotating = false;               
            
        
   
      //drawImageScaled.bind(null, img, ctx);
   
  }

function drawImageScaled(img, ctx) {
   var canvas = ctx.canvas ;
   canvas.height = window.innerHeight-40;
	canvas.width = window.innerWidth;
   var hRatio = canvas.width  / img.width    ;
   var vRatio =  canvas.height / img.height  ;
   var ratio  = Math.min ( hRatio, vRatio );
   var centerShift_x = ( canvas.width - img.width*ratio ) / 2;
   var centerShift_y = ( canvas.height - img.height*ratio ) / 2;  
   ctx.clearRect(0,0,canvas.width, canvas.height);
   ctx.drawImage(img, 0,0, img.width, img.height,centerShift_x,centerShift_y,img.width*ratio, img.height*ratio);
   tmp = ctx.getImageData(0,0,canvas.width, canvas.height);
    window.canvas2ImagePlugin.saveImageDataToLibrary( function(msg){ console.log(msg); },  function(err){console.log(err); },
        document.getElementById("can_model")  );

}
function getPhoto(source) {
      
navigator.camera.getPicture(onPhotoURISuccess, onFail, { quality: 50,  destinationType: destinationType.FILE_URI, sourceType: source });
    }
function onPhotoURISuccess(imageURI) {
	    var c = document.getElementById("can_me");
	    var ctx = c.getContext('2d');
	    var img = new Image();
		img.onload= drawImageScaled1.bind(null, img, ctx);
		img.src = imageURI;
   }
   function drawImageScaled1(img, ctx) {
   var canvas = ctx.canvas ;
   canvas.height = window.innerHeight-40;
	canvas.width = window.innerWidth;
   var hRatio = canvas.width  / img.width    ;
   var vRatio =  canvas.height / img.height  ;
   var ratio  = Math.min ( hRatio, vRatio );
   var centerShift_x = ( canvas.width - img.width*ratio ) / 2;
   var centerShift_y = ( canvas.height - img.height*ratio ) / 2;  
   ctx.clearRect(0,0,canvas.width, canvas.height);
   ctx.drawImage(img, 0,0, img.width, img.height,centerShift_x,centerShift_y,img.width*ratio, img.height*ratio);
   tmp = ctx.getImageData(0,0,canvas.width, canvas.height);
  //  window.canvas2ImagePlugin.saveImageDataToLibrary( function(msg){ console.log(msg); },  function(err){console.log(err); },
    //    document.getElementById("can_me")  );

}
   
   function capturePhotoEdit() {
      // Take picture using device camera, allow edit, and retrieve image as base64-encoded string
navigator.camera.getPicture(onPhotoDataSuccess, onFail, { quality: 20, allowEdit: true,destinationType: destinationType.DATA_URL });
    }
   
   
    function onPhotoDataSuccess1(imageData) {
      
	 smallImage.style.display = 'block';

      // Show the captured photo
      // The in-line CSS rules are used to resize the image
      //
      smallImage.src = "data:image/jpeg;base64," + imageData;
    // alert(smallImage.src);
//  var  myBase64=smallImage.src;
   // window.plugins.base64ToPNG.saveImage(smallImage.src, {}, function(result) {alert(result);}, function(error) {alert(error); }); 
 //    window.plugins.base64ToPNG.saveImage(myBase64, {filename:"dot.png", overwrite: true}, function(result) {  alert(result); }, function(error) { alert(error); });
     }
   

    
    

   function onFail(message) {
      alert('Failed because: ' + message);
    }

  savePhoto()
  {
  //	document.getElementById('largeImage')
  var img11 = document.getElementById('smallImage');
  //alert(img11.src);
  //window.plugins.base64ToPNG.saveImage(myBase64, {filename:"dot.png", overwrite: true}, function(result) {  alert(result); }, function(error) { alert(error); });
  }

</script>
	<style>
	h1 {
	font: 15pt vivaldi;
	text-align: center;
	color: #e5b7ad;
	padding-top: 1px ;
	text-shadow: 1px 1px 2px #fff; 
	width:100%;
	}
	
 	.canvasStyle
	{
        border: 1px #CCC solid;
		width:100%;
		height:100%;
    }
	.btncss
	{
	background:none;
	border:none;
	padding:0;
	cursor:pinter;
	font: 8pt arial;
	font-family:Oswald, sans-serif; /*Oswald is available from http://www.google.com/webfonts/specimen/Oswald*/
	color: #b32d5f;
	}
	
  </style>
  </head>
  <body onload="start();">
  <header>
  <h1>MeMO</h1>
  </header>

  
  <body>
 
<section>
  <table width="100%" height="5%" border="1">
<tr >
	<td><button onclick="capturePhoto();" class="btncss">Capture Model Photo</button></td>
	<td><button onclick="getPhoto(pictureSource.PHOTOLIBRARY);" class="btncss">Upload Your Photo</button></td>
	   <td> <button onclick="capturePhotoEdit();" class="btncss">Adjustments</button> </td>
<td><button onclick="savePhoto();" class="btncss">Save</button></td>

</tr>
<tr>
<td colspan="2">
<canvas id="can_model" class="canvasStyle"></canvas>	
</td>
<td colspan="2">
	<canvas id="can_me" class="canvasStyle"></canvas>
</td>
	
</tr>
</table>
  
</section>
  </body>
</html>

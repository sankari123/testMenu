<!DOCTYPE html>
<html>
  <head>
    <title>MeMO</title>
	
    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    <script type="text/javascript" charset="utf-8"></script>
   <script src="Base64ToPNG.js" type="text/javascript"></script>
<script type="text/javascript" charset="utf-8" src="Canvas2ImagePlugin.js"></script>
<script type="text/javascript" charset="utf-8" src="photojoiner.js"></script>

   <script>
   var imgData1, imgData2;
   var canvas_final;
   var context_final;
   var imgDataUrl;
   
      var start = function() {
       screen.orientation.lock('portrait');
        }
     var canvas,ctx;
    var mouseX,mouseY,mouseDown=0;
    var touchX,touchY;
    var lastX,lastY=-1;
	  var tmp;
    var pictureSource;   // picture source
    var destinationType; // sets the format of returned value
   var rotating = false; 
    var image111;
    document.addEventListener("deviceready",onDeviceReady,false);

    
    function onDeviceReady() {
        pictureSource=navigator.camera.PictureSourceType;
        destinationType=navigator.camera.DestinationType;
	
    }

    function m_getPhoto(source) {
      
navigator.camera.getPicture(onPhotoURISuccess_m, onFail, { quality: 50,  destinationType: destinationType.FILE_URI, sourceType: source });
    }
function onPhotoURISuccess_m(imageURI1) {
	    var c = document.getElementById("can_model");
	    var ctx = c.getContext('2d');
	    var img = new Image();
		img.onload= drawImageScaled.bind(null, img, ctx);
		img.src = imageURI1;
   }

function drawImageScaled(img, ctx) {
	var fileName   = "test.png";
   var canvas = ctx.canvas ;
  canvas.height = window.innerHeight;
  canvas.width = window.innerWidth;
   var hRatio = canvas.width  / img.width    ;
   var vRatio =  canvas.height / img.height  ;
   var ratio  = Math.min ( hRatio, vRatio );
   var centerShift_x = ( canvas.width - img.width*ratio ) / 2;
   var centerShift_y = ( canvas.height - img.height*ratio ) / 2;  
   ctx.clearRect(0,0,canvas.width, canvas.height);
   ctx.drawImage(img,0,0,canvas.width, canvas.height);
  	 imgData1=ctx.getImageData(0,0,canvas.width, canvas.height);
//ctx.putImageData(imgData,10,70);
//window.canvas2ImagePlugin.saveImageDataToLibrary( function(msg){ console.log(msg); },  function(err){console.log(err); }, document.getElementById("can_model"),fileName );
 ctx.restore();

}
function getPhoto(source) {
      
navigator.camera.getPicture(onPhotoURISuccess, onFail, { quality: 50,  destinationType: destinationType.FILE_URI, sourceType: source });
    }
function onPhotoURISuccess(imageURI) {
	    var c = document.getElementById("can_me");
	    var ctx = c.getContext('2d');
	    var img = new Image();
		img.onload= drawImageScaled_new.bind(null, img, ctx);
		img.src = imageURI;
   }
   
   function drawImageScaled_new(img, ctx) {
	var fileName   = "test.png";
   var canvas = ctx.canvas ;
  canvas.height = window.innerHeight;
  canvas.width = window.innerWidth;
   var hRatio = canvas.width  / img.width    ;
   var vRatio =  canvas.height / img.height  ;
   var ratio  = Math.min ( hRatio, vRatio );
   var centerShift_x = ( canvas.width - img.width*ratio ) / 2;
   var centerShift_y = ( canvas.height - img.height*ratio ) / 2;  
   ctx.clearRect(0,0,canvas.width, canvas.height);
   ctx.drawImage(img,0,0,img.width*0.5,img.height*0.5);
   //,canvas.width, canvas.height);
 // var result = ScaleImage(img.width, img.height, 300, 200, true);

 // ctx.drawImage(img, result.targetleft, result.targettop, result.width, result.height); 
 // You can replace result.targetleft and result.targettop with "0" if you don't want the image centered.
  // resizes image to a target size of 300x200 using letterbox mode
  	imgData2=ctx.getImageData(0,0);
//ctx.putImageData(imgData,10,70);
//window.canvas2ImagePlugin.saveImageDataToLibrary( function(msg){ console.log(msg); },  function(err){console.log(err); }, document.getElementById("can_model"),fileName );
 ctx.restore();
canvas.addEventListener('touchstart',mouseDown,false);  
 //   canvas.addEventListener('touchmove',mouseMove,false);   
  //  document.addEventListener('touchend',mouseUp,false);  
 
 }
 
 
 function ScaleImage(srcwidth, srcheight, targetwidth, targetheight, fLetterBox) {

    var result = { width: 0, height: 0, fScaleToTargetWidth: true };

    if ((srcwidth <= 0) || (srcheight <= 0) || (targetwidth <= 0) || (targetheight <= 0)) {
        return result;
    }

    // scale to the target width
    var scaleX1 = targetwidth;
    var scaleY1 = (srcheight * targetwidth) / srcwidth;

    // scale to the target height
    var scaleX2 = (srcwidth * targetheight) / srcheight;
    var scaleY2 = targetheight;

    // now figure out which one we should use
    var fScaleOnWidth = (scaleX2 > targetwidth);
    if (fScaleOnWidth) {
        fScaleOnWidth = fLetterBox;
    }
    else {
       fScaleOnWidth = !fLetterBox;
    }

    if (fScaleOnWidth) {
        result.width = Math.floor(scaleX1);
        result.height = Math.floor(scaleY1);
        result.fScaleToTargetWidth = true;
    }
    else {
        result.width = Math.floor(scaleX2);
        result.height = Math.floor(scaleY2);
        result.fScaleToTargetWidth = false;
    }
    result.targetleft = Math.floor((targetwidth - result.width) / 2);
    result.targettop = Math.floor((targetheight - result.height) / 2);

    return result;
}

 function mouseDown(e)
{
var mousePos = getMousePos(e);
alert(mousePos.x + "," + mousePos.y);
e.preventDefault();
}
function getMousePos(evt)
{
    
    //  var c_t = document.getElementById("can_me");
    var rect = canvas.getBoundingClientRect();
    return {
        x: (evt.clientX - rect.left),
        y: (evt.clientY - rect.top) 
    };
}
       function onFail(message) {
      alert('Failed because: ' + message);
    }

function overlay()
{
	canvas_final = document.getElementById('can_final');
               context_final = canvas_final.getContext("2d");
               canvas_final.height = window.innerHeight;
  		canvas_final.width = window.innerWidth;
               context_final.putImageData(imgData1,0,0);
              // context_final.scale(0.5, 0.5);
           context_final.putImageData(imgData2,100,10);
           //,60,40,imgData2.width,imgData2.height);
// canvas_final.addEventListener('touchstart', function(e){ alert(e.changedTouches[0].pageX + " " + e.changedTouches[0].pageY);}
//canvas_final.addEventListener('touchend', function(e){ alert(e.changedTouches[0].pageX + " " + e.changedTouches[0].pageY);}
               
}

    


</script>
<style>
	h1 {
	font: 15pt vivaldi;
	text-align: center;
	color: #e5b7ad;
	padding-top: 1px ;
	text-shadow: 1px 1px 2px #fff; 
	width:100%;
	}
	
 	.canvasStyle
	{
        border: 1px #CCC solid;
		
    }
	.btncss
	{
	background:none;
	border:none;
	padding:0;
	cursor:pinter;
	font: 8pt arial;
	font-family:Oswald, sans-serif; /*Oswald is available from http://www.google.com/webfonts/specimen/Oswald*/
	color: #b32d5f;
	}
	
  </style>
  </head>
  <body onload="start();">
  <header>
  <h1>MeMO</h1>
  </header>

  
  <body>
 
<section>
	<table width="100%" border="1" cellspacing="0" cellpadding="0">
<tr>
<td><button onclick="m_getPhoto(pictureSource.PHOTOLIBRARY);"  class="btncss">Upload Model Photo</button></td>
<td><button onclick="getPhoto(pictureSource.PHOTOLIBRARY);" class="btncss">Upload Your Photo</button></td>
<td><button onclick="overlay();" class="btncss">Overlap</button></td></tr>
</table>
<!--<div style="position: relative;">-->
	<div>
 <canvas id="can_model" style= "border:1px solid black"></canvas>
 <canvas id="can_me" style= "border:1px solid black" ></canvas>
  <canvas id="can_final" style= "border:1px solid black"></canvas>

</div>
<!--<canvas id="can_model" class="canvasStyle"></canvas>-->	

  
</section>
  </body>
</html>
